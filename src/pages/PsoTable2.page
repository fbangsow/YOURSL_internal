<apex:page sidebar="false" name="PSOTable2" controller="PsoTable2Controller">
	<apex:includeScript value="{!URLFOR($Resource.jQuery_2_2_0)}"/>
	<apex:includeScript value="{!URLFOR($Resource.StreamingApiScripts,'json2.js')}"/>
	<apex:includeScript value="{!URLFOR($Resource.StreamingApiScripts,'Cometd.js')}"/>
	<apex:includeScript value="{!URLFOR($Resource.StreamingApiScripts,'jquery.cometd.js')}"/>
	<apex:includeScript value="{!URLFOR($Resource.jQuery_ui_1_11_4,'jquery-ui.min.js')}"/>
	<apex:includeScript value="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.9/angular.min.js" />
	<apex:includeScript value="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.9/angular-cookies.min.js" />
	<apex:includeScript value="{!URLFOR($Resource.PsoTable2,'js/core.js')}"/>
	<apex:includeScript value="{!URLFOR($Resource.PsoTable2,'js/controllers/root.js')}"/>
	<apex:includeScript value="{!URLFOR($Resource.PsoTable2,'js/controllers/staffing.js')}"/>

	<link rel="stylesheet" href="{!URLFOR($Resource.jQuery_ui_1_11_4,'jquery-ui.min.css')}" />
	<link rel="stylesheet" href="{!URLFOR($Resource.PsoTable2,'css/main.css')}" />

	<apex:form >
		<div data-ng-app="PsoTable2" data-ng-controller="PsoTable2" id="pso-table">
			<apex:pageBlock title="Loading" html-data-ng-if="status.loading">
			</apex:pageBlock>

			<apex:pageBlock html-data-ng-if="!status.loading" title="Apply filters">
				<div class="ui-helper-clearfix">
					<section id="opportunities-filter">
						<h3><label for="selectedOpportunities">Select opportunities:</label></h3>

						<select multiple="multiple" name="selectedOpportunities" id="selectedOpportunities" ng-model="viewState.selectedOpportunities" ng-attr-size="{{ viewState.selectedOpportunitiesSize }}">
							<optgroup ng-repeat="customer in opportunitiesFilter.Customers | filter : opportunitiesFilter.customerMatchesFilter" label="{{ customer.AccountName }}" ng-click="opportunitiesFilter.events.accountClicked(customer, $event)">
								<option ng-repeat="project in customer.Projects | filter : opportunitiesFilter.projectMatchesFilter" value="{{ project.OpportunityId }}">
									{{ project.OpportunityName }}
								</option>
							</optgroup>
						</select>

						<input type="search" placeholder="Filter opportunities" ng-model="viewState.opportunitiesFilterText" ng-change="opportunitiesFilter.removeFilteredOpportunitiesFromSelection()" />

						<a href="#" ng-click="opportunitiesFilter.selectAllOpportunities()">Select all</a>
						<a href="#" ng-click="opportunitiesFilter.clearSelectedOpportunities()">Clear</a>

						<button ng-click="opportunitiesFilter.events.updateStaffingClicked($event)">Update staffing view</button>
					</section>
				</div>
			</apex:pageBlock>

			<apex:pageBlock html-data-ng-show="status.loaded" title="Manage staffing" html-ng-controller="PsoTable2Staffing" html-ng-init="viewState.staticStaffingColumns = 3">
				<section id="staffing">
					<table>
						<tbody data-ng-if="staffing.Customers.length" ng-repeat="customer in staffing.Customers">
							<tr>
								<td colspan="{{ viewState.staffingColumns }}" class="customer-info">
									<article>
										<h4><a href="/{{ customer.AccountId }}" target="_blank">{{ customer.AccountName }}</a></h4>
									</article>
								</td>
							</tr>
							<tr ng-repeat-start="project in customer.Projects">
								<td colspan="{{ viewState.staffingColumns }}" class="project-info">
									<article>
										<h5><a href="/{{ project.OpportunityId }}" target="_blank">{{ project.OpportunityName }}</a></h5>
									</article>
								</td>
							</tr>
							<tr>
								<th rowspan="4">Resource</th>
								<th rowspan="4">Role</th>
								<th rowspan="4">Sold days</th>
								<th colspan="{{ month.dayCount }}" ng-repeat="month in viewState.staffingMonths">
									{{ month.caption }}
								</th>
							</tr>
							<tr>
								<th colspan="{{ week.dayCount }}" ng-repeat="week in viewState.staffingWeeks">
									CW-{{ week.number }}
								</th>
							</tr>
							<tr>
								<th ng-repeat="day in viewState.staffingDays" ng-class="{weekend:day.isWeekEnd,past:day.isPast,today:day.isToday,future:day.isFuture}">
									{{ day.weekDay }}
								</th>
							</tr>
							<tr>
								<th ng-repeat="day in viewState.staffingDays" ng-class="{weekend:day.isWeekEnd,past:day.isPast,today:day.isToday,future:day.isFuture}">
									{{ day.day }}
								</th>
							</tr>
							<tr ng-repeat-end="true" ng-repeat="resource in project.Resources">
								<td>
									<a href="/{{ resource.ContactId }}" target="_blank">{{ resource.ResourceName }}</a>
								</td>
								<td>
									{{ resource.Product }}
								</td>
								<td>
									{{ resource.SoldDays / 8 }}
								</td>
								<td ng-repeat="day in viewState.staffingDays" ng-init="staffing = resource.StaffingByDay[day.dateString]" ng-class="{weekend:day.isWeekEnd,past:day.isPast,today:day.isToday,future:day.isFuture,'has-booking':staffing.hasBooking,'partly-booked':staffing.isPartlyBooked,'fully-booked':staffing.isFullyBooked,'has-holiday':staffing.hasHoliday,holiday:staffing.isFullHoliday,'part-holiday':isPartlyHoliday,'fully-blocked':staffing.isFullyBlocked,overblocked:staffing.isOverBlocked}">
									<span ng-if="staffing !== undefined">
										{{ staffing.blockedHours }}
									</span>
								</td>
							</tr>
						</tbody>
					</table>
				</section>
			</apex:pageBlock>
		</div>
	</apex:form>
</apex:page>